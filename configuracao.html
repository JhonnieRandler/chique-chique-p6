<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurações | ChronoFlow</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body id="config-body">
    <div class="config-page-container">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">
        Painel de Configurações
      </h1>
      <p class="text-gray-600 mb-8">Selecione uma opção para configurar.</p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Cards de Configuração -->
        <div id="config-weeks" class="config-card">
          <div class="config-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">
              Mapeamento de Semanas
            </h2>
            <p class="text-gray-600 text-sm">
              Defina o início e fim de cada semana do projeto.
            </p>
          </div>
        </div>
        <div id="config-resource" class="config-card">
          <div class="config-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">Recurso Principal</h2>
            <p class="text-gray-600 text-sm">
              Defina o recurso de avanço físico do projeto.
            </p>
          </div>
        </div>
        <div id="config-grouping" class="config-card">
          <div class="config-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h7"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">Agrupamento Semanal</h2>
            <p class="text-gray-600 text-sm">
              Escolha como agrupar atividades na visão de 6 semanas.
            </p>
          </div>
        </div>
        <div id="config-hidden-activities" class="config-card">
          <div class="config-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m0 0l-2.14 2.14"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">Ocultar Atividades</h2>
            <p class="text-gray-600 text-sm">
              Selecione atividades para não exibir na visão de 6 semanas.
            </p>
          </div>
        </div>
        <div id="config-restrictions" class="config-card">
          <div class="config-icon bg-red-100 text-red-700">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 9v2m0 4h.01"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">
              Gerenciar Restrições
            </h2>
            <p class="text-gray-600 text-sm">
              Crie, edite e vincule restrições às atividades do projeto.
            </p>
          </div>
        </div>
        <div id="config-activity-mapping" class="config-card">
          <div class="config-icon bg-green-100 text-green-700">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h6l2-2h2l-2 2z"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">
              Mapeamento de Atividades
            </h2>
            <p class="text-gray-600 text-sm">
              Agrupe atividades que representam o mesmo trabalho.
            </p>
          </div>
        </div>
        <div id="config-custom-values" class="config-card">
          <div class="config-icon bg-yellow-100 text-yellow-700">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">
              Valores Personalizados
            </h2>
            <p class="text-gray-600 text-sm">
              Insira valores previstos e realizados para atividades ou grupos.
            </p>
          </div>
        </div>
        <div id="config-backup" class="config-card">
          <div class="config-icon bg-gray-200 text-gray-700">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"
              />
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-lg text-gray-800">
              Importar & Exportar Dados
            </h2>
            <p class="text-gray-600 text-sm">
              Salve um backup de todos os dados e configurações ou restaure a
              partir de um arquivo salvo.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Genérico -->
    <div id="modal" class="modal-overlay">
      <div class="modal-content">
        <div
          id="modal-header"
          class="flex-shrink-0 px-6 sm:px-8 pt-6 pb-4 border-b border-gray-200"
        >
          <div class="flex justify-between items-start">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800"></h2>
            <button
              id="modal-close-btn"
              class="text-gray-400 hover:text-gray-700 text-3xl"
            >
              &times;
            </button>
          </div>
          <div
            id="modal-header-extra"
            class="flex justify-between items-center mt-2"
          >
            <p id="modal-subtitle" class="text-gray-600 text-sm"></p>
            <div id="modal-header-actions"></div>
          </div>
        </div>
        <div id="modal-body" class="px-6 sm:px-8 py-6"></div>
        <div
          id="modal-footer"
          class="flex-shrink-0 px-6 sm:px-8 pt-4 pb-6 mt-auto bg-gray-50 border-t"
        >
          <div id="modal-message-area" class="mb-4"></div>
          <div class="flex justify-end gap-4">
            <button
              id="modal-cancel-btn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
            >
              Cancelar
            </button>
            <button
              id="modal-save-btn"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
              disabled
            >
              Salvar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- App Scripts as a module -->
    <script type="module">
      import {
        initializationError,
        showFirebaseError,
      } from "./firebase-config.js";
      import * as utils from "./utils.js";

      // First, check if Firebase is configured. If not, show an error and stop.
      if (initializationError) {
        utils.insertHeader(); // Show nav so user isn't stuck
        showFirebaseError();
        throw initializationError; // Halt script execution
      }

      // If no error, import other modules and run the app
      import { storage } from "./storage.js";

      // ===== Page Script Starts Here =====
      utils.insertHeader();

      let projectBaseData = null;
      let activeTomSelects = [];
      let currentEditingId = null;
      let fileToImport = null;

      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modal-title");
      const modalSubtitle = document.getElementById("modal-subtitle");
      const modalHeaderActions = document.getElementById(
        "modal-header-actions"
      );
      const modalBody = document.getElementById("modal-body");
      const modalMessageArea = document.getElementById("modal-message-area");
      const modalSaveBtn = document.getElementById("modal-save-btn");

      function showMessage(text, type, duration = 3000) {
        modalMessageArea.innerHTML = `<div class="message-box ${type}">${text}</div>`;
        if (duration > 0) {
          setTimeout(() => {
            modalMessageArea.innerHTML = "";
          }, duration);
        }
      }

      async function getProjectBase() {
        if (projectBaseData) return projectBaseData;
        projectBaseData = await storage.getProjectBase();
        return projectBaseData;
      }

      /**
       * Enables the save button once a change is detected in the modal body.
       * The listeners remove themselves after the first interaction for efficiency.
       */
      function activateChangeDetection() {
        if (!modalSaveBtn.onclick) return;

        modalSaveBtn.disabled = true;

        const enableButton = () => {
          modalSaveBtn.disabled = false;
          // Clean up listeners after first use
          modalBody.removeEventListener("change", enableButton);
          modalBody.removeEventListener("input", enableButton);
        };

        modalBody.addEventListener("change", enableButton, { once: true });
        modalBody.addEventListener("input", enableButton, { once: true });
      }

      async function openModal(module) {
        modalTitle.textContent = module.title;
        modalSubtitle.textContent = module.subtitle || "";
        modalBody.innerHTML =
          '<div class="message-box info">Carregando...</div>';

        modal.classList.add("active");
        if (module.needsMoreHeight) {
          modal.classList.add("modal-large");
        }

        document.getElementById("modal-footer").style.display = "flex";
        modalSaveBtn.style.display = "inline-flex";

        const projectData = await getProjectBase();
        if (!projectData || Object.keys(projectData).length === 0) {
          modalBody.innerHTML = `<p class="message-box error">Nenhum dado de projeto base encontrado. Por favor, carregue um arquivo .xer na página principal primeiro.</p>`;
          modalSaveBtn.style.display = "none";
          return;
        }

        modalBody.innerHTML = await module.setup(projectData);
        modalHeaderActions.innerHTML = "";

        if (module.headerAction) {
          const btn = document.createElement("button");
          btn.id = module.headerAction.id;
          btn.innerHTML = module.headerAction.icon;
          btn.title = module.headerAction.tooltip;
          btn.className =
            "bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition-colors";
          modalHeaderActions.appendChild(btn);
        }
        activeTomSelects.forEach((ts) => ts.destroy());
        activeTomSelects = [];
        modalMessageArea.innerHTML = "";

        if (module.save) {
          modalSaveBtn.onclick = module.save;
          activateChangeDetection();
        } else {
          modalSaveBtn.style.display = "none";
          modalSaveBtn.onclick = null;
        }
      }

      function closeModal() {
        modal.classList.remove("active");
        modal.classList.remove("modal-large");
        fileToImport = null;
      }

      function successfulSave(message) {
        showMessage(message, "success", 2000);
        setTimeout(closeModal, 1500);
      }

      function uuidv4() {
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, (c) =>
          (
            c ^
            (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))
          ).toString(16)
        );
      }

      async function renderActivityMappingTable() {
        let savedMapping = await storage.getData(
          storage.APP_KEYS.ACTIVITY_MAPPING_KEY
        );
        modalSaveBtn.style.display = "none";
        modalSubtitle.textContent =
          "Gerencie grupos de atividades que representam o mesmo trabalho.";
        if (document.getElementById("add-new-group-btn")) {
          document.getElementById("add-new-group-btn").onclick = () =>
            renderGroupEditForm();
        }

        savedMapping.sort((a, b) => a.groupName.localeCompare(b.groupName));
        let tableHtml = `<div class="table-container"><table><thead><tr><th>Nome do Grupo</th><th>Nº de Atividades</th><th class="text-right">Ações</th></tr></thead><tbody>`;
        if (savedMapping.length > 0) {
          savedMapping.forEach((group, index) => {
            tableHtml += `<tr><td class="font-semibold">${group.groupName}</td><td>${group.taskCodes.length}</td><td class="text-right"><div class="flex items-center justify-end gap-2"><button class="edit-group-btn text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-100" data-group-name="${group.groupName}" title="Editar Grupo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.5 6.036z" /></svg></button><button class="delete-group-btn text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100" data-group-name="${group.groupName}" title="Excluir Grupo"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td></tr>`;
          });
        } else {
          tableHtml += `<tr><td colspan="3" class="text-center text-gray-500 py-6">Nenhum grupo de atividades criado.</td></tr>`;
        }
        tableHtml += `</tbody></table></div>`;
        modalBody.innerHTML = tableHtml;
        document
          .querySelectorAll(".edit-group-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              renderGroupEditForm(e.currentTarget.dataset.groupName)
            )
          );
        document
          .querySelectorAll(".delete-group-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              deleteGroup(e.currentTarget.dataset.groupName)
            )
          );
      }

      async function renderGroupEditForm(groupName = null) {
        const savedMapping = await storage.getData(
          storage.APP_KEYS.ACTIVITY_MAPPING_KEY
        );
        const group = groupName
          ? savedMapping.find((g) => g.groupName === groupName)
          : { groupName: "", taskCodes: [] };
        currentEditingId = groupName;
        modalSubtitle.textContent = groupName
          ? `Editando o grupo "${groupName}"`
          : "Criando um novo grupo de atividades.";
        modalSaveBtn.style.display = "inline-flex";
        modalHeaderActions.innerHTML = "";
        modalBody.innerHTML = `<div class="space-y-4"><div><label class="font-bold text-gray-700">Nome do Grupo:</label><input type="text" id="group-name-input" value="${group.groupName}" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="Ex: Escavação Total C2+C3"></div><div><label class="font-semibold text-gray-700 mt-2 block">Atividades do Grupo:</label><select id="activity-group-select" multiple></select></div></div>`;
        const usedTaskCodes = new Set();
        savedMapping.forEach((g) => {
          if (g.groupName !== groupName) {
            g.taskCodes.forEach((code) => usedTaskCodes.add(code));
          }
        });
        const selectEl = document.getElementById("activity-group-select");
        const allTasks = (await getProjectBase())?.TASK?.rows || [];
        const availableTasks = allTasks.filter(
          (task) => !usedTaskCodes.has(task.task_code)
        );
        const options = availableTasks
          .map((task) => ({
            value: task.task_code,
            text: `${task.task_code} - ${task.task_name}`,
          }))
          .sort((a, b) => a.text.localeCompare(b.text));
        const tomSelect = new TomSelect(selectEl, {
          options,
          plugins: ["remove_button"],
          placeholder: "Selecione 2 ou mais atividades...",
        });
        tomSelect.setValue(group.taskCodes);
        activeTomSelects.push(tomSelect);
        activateChangeDetection();
      }

      async function renderCustomValuesTable() {
        let savedValues = await storage.getData(
          storage.APP_KEYS.CUSTOM_VALUES_KEY
        );
        modalSaveBtn.style.display = "none";
        modalSubtitle.textContent =
          "Gerencie valores que sobrepõem os dados do cronograma.";
        document
          .getElementById("add-custom-value-btn")
          ?.addEventListener("click", () => renderCustomValueEditForm());

        const project = await getProjectBase();
        const mapping = await storage.getData(
          storage.APP_KEYS.ACTIVITY_MAPPING_KEY
        );

        const allItems = [
          ...(project?.TASK?.rows || []).map((t) => ({
            id: t.task_code,
            name: `${t.task_code} - ${t.task_name}`,
          })),
          ...mapping.map((g) => ({
            id: `group::${g.groupName}`,
            name: `[Grupo] ${g.groupName}`,
          })),
        ];
        const itemsMap = new Map(allItems.map((i) => [i.id, i.name]));
        savedValues.forEach(
          (val) => (val.name = itemsMap.get(val.id) || val.id)
        );
        savedValues.sort((a, b) => a.name.localeCompare(b.name));
        let tableHtml = `<div class="table-container"><table><thead><tr><th>Atividade / Grupo</th><th class="text-right">Previsto</th><th class="text-right">Realizado</th><th class="text-right">Ações</th></tr></thead><tbody>`;
        if (savedValues.length > 0) {
          savedValues.forEach((val) => {
            tableHtml += `<tr><td class="font-semibold">${
              val.name
            }</td><td class="text-right">${utils.formatNumberBR(
              val.planned
            )}</td><td class="text-right">${utils.formatNumberBR(
              val.actual
            )}</td><td class="text-right"><div class="flex items-center justify-end gap-2"><button class="edit-custom-value-btn text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-100" data-id="${
              val.id
            }" title="Editar Valor"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.5 6.036z" /></svg></button><button class="delete-custom-value-btn text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100" data-id="${
              val.id
            }" title="Excluir Valor"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></td></tr>`;
          });
        } else {
          tableHtml += `<tr><td colspan="4" class="text-center text-gray-500 py-6">Nenhum valor personalizado definido.</td></tr>`;
        }
        tableHtml += `</tbody></table></div>`;
        modalBody.innerHTML = tableHtml;
        document
          .querySelectorAll(".edit-custom-value-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              renderCustomValueEditForm(e.currentTarget.dataset.id)
            )
          );
        document
          .querySelectorAll(".delete-custom-value-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              deleteCustomValue(e.currentTarget.dataset.id)
            )
          );
      }

      async function renderCustomValueEditForm(id = null) {
        const savedValues = await storage.getData(
          storage.APP_KEYS.CUSTOM_VALUES_KEY
        );
        const value = id
          ? savedValues.find((v) => v.id === id)
          : { id: null, planned: "", actual: "" };
        currentEditingId = id;
        modalSaveBtn.style.display = "inline-flex";
        modalHeaderActions.innerHTML = "";
        modalSubtitle.textContent = id
          ? `Editando valor para "${value.name || id}"`
          : "Criando um novo valor personalizado.";
        modalBody.innerHTML = `<div class="space-y-4"><div><label class="font-bold text-gray-700">Atividade ou Grupo</label><select id="custom-value-select" class="mt-1"></select></div><div class="grid grid-cols-2 gap-4"><div><label class="font-bold text-gray-700">Previsto Personalizado</label><input type="number" step="any" id="custom-planned-input" class="w-full p-2 border border-gray-300 rounded-md mt-1" value="${
          value.planned ?? ""
        }" placeholder="Ex: 1500.50"></div><div><label class="font-bold text-gray-700">Realizado Personalizado</label><input type="number" step="any" id="custom-actual-input" class="w-full p-2 border border-gray-300 rounded-md mt-1" value="${
          value.actual ?? ""
        }" placeholder="Ex: 750.25"></div></div></div>`;
        const usedValueIds = new Set(savedValues.map((v) => v.id));
        if (id) {
          usedValueIds.delete(id);
        }
        const project = await getProjectBase();
        const mapping = await storage.getData(
          storage.APP_KEYS.ACTIVITY_MAPPING_KEY
        );
        const allTasks = (project?.TASK?.rows || []).map((t) => ({
          value: t.task_code,
          text: `${t.task_code} - ${t.task_name}`,
        }));
        const allGroups = mapping.map((g) => ({
          value: `group::${g.groupName}`,
          text: `[Grupo] ${g.groupName}`,
        }));
        const allOptions = [...allTasks, ...allGroups];
        const availableOptions = allOptions
          .filter((opt) => !usedValueIds.has(opt.value))
          .sort((a, b) => a.text.localeCompare(b.text));
        const tomSelect = new TomSelect("#custom-value-select", {
          options: availableOptions,
          placeholder: "Selecione...",
        });
        tomSelect.setValue(value.id);
        if (id) {
          tomSelect.disable();
        }
        activeTomSelects.push(tomSelect);
        activateChangeDetection();
      }

      async function saveGroup() {
        const groupName = document.getElementById("group-name-input").value;
        const tomSelect = activeTomSelects[0];
        const taskCodes = tomSelect ? tomSelect.getValue() : [];
        if (!groupName.trim()) {
          showMessage("O nome do grupo não pode ser vazio.", "error");
          return;
        }
        if (taskCodes.length < 2) {
          showMessage("Um grupo deve ter pelo menos 2 atividades.", "error");
          return;
        }
        let savedMapping = await storage.getData(
          storage.APP_KEYS.ACTIVITY_MAPPING_KEY
        );
        const newGroup = { groupName, taskCodes };
        if (currentEditingId !== null) {
          const index = savedMapping.findIndex(
            (g) => g.groupName === currentEditingId
          );
          if (index > -1) savedMapping[index] = newGroup;
        } else {
          savedMapping.push(newGroup);
        }
        await storage.saveData(
          storage.APP_KEYS.ACTIVITY_MAPPING_KEY,
          savedMapping
        );
        successfulSave("Grupo salvo com sucesso!");
      }

      async function deleteGroup(groupName) {
        if (confirm(`Tem certeza que deseja excluir o grupo "${groupName}"?`)) {
          let savedMapping = await storage.getData(
            storage.APP_KEYS.ACTIVITY_MAPPING_KEY
          );
          const newMapping = savedMapping.filter(
            (g) => g.groupName !== groupName
          );
          await storage.saveData(
            storage.APP_KEYS.ACTIVITY_MAPPING_KEY,
            newMapping
          );
          showMessage("Grupo excluído.", "success");
          await renderActivityMappingTable();
        }
      }
      async function saveCustomValue() {
        const tomSelect = document.getElementById(
          "custom-value-select"
        ).tomselect;
        const selectedId = tomSelect ? tomSelect.getValue() : null;
        const plannedVal = document.getElementById(
          "custom-planned-input"
        ).value;
        const actualVal = document.getElementById("custom-actual-input").value;

        if (!selectedId) {
          showMessage("Selecione uma atividade ou grupo.", "error");
          return;
        }
        if (plannedVal.trim() === "" && actualVal.trim() === "") {
          showMessage(
            "Preencha pelo menos um dos valores (previsto ou realizado).",
            "error"
          );
          return;
        }

        let savedValues = await storage.getData(
          storage.APP_KEYS.CUSTOM_VALUES_KEY
        );
        const newValue = {
          id: selectedId,
          planned: plannedVal.trim() !== "" ? parseFloat(plannedVal) : null,
          actual: actualVal.trim() !== "" ? parseFloat(actualVal) : null,
        };

        const indexToUpdate = savedValues.findIndex(
          (v) => v.id === currentEditingId
        );

        if (indexToUpdate > -1) {
          savedValues[indexToUpdate] = newValue;
        } else {
          savedValues.push(newValue);
        }
        await storage.saveData(storage.APP_KEYS.CUSTOM_VALUES_KEY, savedValues);
        successfulSave("Valor personalizado salvo!");
      }
      async function deleteCustomValue(id) {
        if (
          confirm("Tem certeza que deseja excluir este valor personalizado?")
        ) {
          let savedValues = await storage.getData(
            storage.APP_KEYS.CUSTOM_VALUES_KEY
          );
          const newValues = savedValues.filter((v) => v.id !== id);
          await storage.saveData(storage.APP_KEYS.CUSTOM_VALUES_KEY, newValues);
          showMessage("Valor excluído.", "success");
          await renderCustomValuesTable();
        }
      }

      async function processAndSaveWeeksFile(file) {
        if (!file) {
          showMessage("Por favor, selecione um arquivo.", "error");
          return;
        }
        if (!file.name.toLowerCase().endsWith(".xlsx")) {
          showMessage(
            "Tipo de arquivo inválido. Use um arquivo .xlsx",
            "error"
          );
          document.getElementById("weeks-file-name").textContent = "";
          return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet);
            if (
              json.length === 0 ||
              !json[0].hasOwnProperty("Semana") ||
              !json[0].hasOwnProperty("Data")
            ) {
              throw new Error(
                'O arquivo Excel deve conter as colunas "Semana" e "Data".'
              );
            }
            const processedWeeks = json
              .map((row) => ({
                Semana: row.Semana,
                Data: new Date((row.Data - (25567 + 2)) * 86400 * 1000),
              }))
              .sort((a, b) => a.Data - b.Data);
            const weekRanges = [];
            let currentWeek = null;
            for (let i = 0; i < processedWeeks.length; i++) {
              if (processedWeeks[i].Semana !== currentWeek?.Semana) {
                if (currentWeek) {
                  currentWeek.Data_Fim = new Date(processedWeeks[i - 1].Data);
                  weekRanges.push(currentWeek);
                }
                currentWeek = {
                  Semana: processedWeeks[i].Semana,
                  Data_Inicio: new Date(processedWeeks[i].Data),
                };
              }
            }
            if (currentWeek) {
              currentWeek.Data_Fim = new Date(
                processedWeeks[processedWeeks.length - 1].Data
              );
              weekRanges.push(currentWeek);
            }
            const finalData = weekRanges.map((w) => ({
              Semana: w.Semana,
              Data_Inicio: w.Data_Inicio.toISOString().split("T")[0],
              Data_Fim: w.Data_Fim.toISOString().split("T")[0],
            }));
            await storage.saveData(storage.APP_KEYS.WEEKS_DATA_KEY, finalData);
            successfulSave("Mapeamento de semanas salvo com sucesso!");
          } catch (err) {
            console.error(err);
            showMessage(`Erro ao processar o arquivo: ${err.message}`, "error");
          }
        };
        reader.readAsArrayBuffer(file);
      }

      const CONFIG_MODULES = {
        weeks: {
          title: "Mapeamento de Semanas",
          subtitle:
            'Carregue um arquivo Excel (.xlsx) com as colunas "Semana" e "Data".',
          setup: () =>
            `<div id="weeks-drop-area" class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors"><p class="text-gray-500">Arraste e solte o arquivo .xlsx aqui</p><p class="text-gray-400 my-2">- OU -</p><label for="weeks-file-input" class="cursor-pointer bg-blue-100 text-blue-700 font-semibold px-4 py-2 rounded-md hover:bg-blue-200">Selecionar Arquivo</label><input type="file" id="weeks-file-input" accept=".xlsx" class="hidden"/><p id="weeks-file-name" class="mt-4 text-sm font-medium text-gray-700"></p></div>`,
          save: null,
        },
        resource: {
          title: "Recurso Principal de Avanço",
          subtitle:
            "Selecione o recurso que representa o avanço físico do projeto.",
          setup: async (project) => {
            const resources = project?.RSRC?.rows || [];
            if (resources.length === 0)
              return "<p>Nenhum recurso encontrado. Carregue um arquivo .xer primeiro.</p>";
            const savedResource = await storage.getData(
              storage.APP_KEYS.MAIN_RESOURCE_KEY
            );
            const options = resources
              .map(
                (r) =>
                  `<option value="${r.rsrc_name}" ${
                    savedResource === r.rsrc_name ? "selected" : ""
                  }>${r.rsrc_name}</option>`
              )
              .join("");
            return `<select id="modal-resource-select" class="w-full p-2 border border-gray-300 rounded-md">${options}</select>`;
          },
          save: async () => {
            const select = document.getElementById("modal-resource-select");
            if (select && select.value) {
              await storage.saveData(
                storage.APP_KEYS.MAIN_RESOURCE_KEY,
                select.value
              );
              successfulSave("Recurso salvo!");
            } else {
              showMessage("Nenhum recurso selecionado.", "error");
            }
          },
        },
        grouping: {
          title: "Agrupamento da Visão Semanal",
          subtitle:
            'Selecione os níveis da WBS para agrupar as atividades na página "Próximas Semanas".',
          setup: async (project) => {
            const wbsHierarchy = project?.WBS_HIERARCHY?.rows || [];
            if (wbsHierarchy.length === 0)
              return "<p>Nenhuma hierarquia WBS encontrada. Carregue um arquivo .xer primeiro.</p>";
            const maxLevel = Math.max(
              0,
              ...wbsHierarchy.map((w) => parseInt(w.level, 10))
            );
            const savedLevels = await storage.getData(
              storage.APP_KEYS.WEEKS_VIEW_GROUPING_KEY
            );
            let checkboxesHtml = '<div class="grid grid-cols-4 gap-2">';
            for (let i = 1; i <= maxLevel; i++) {
              checkboxesHtml += `<div><input type="checkbox" id="level-${i}" value="${i}" ${
                savedLevels.includes(i) ? "checked" : ""
              } class="mr-2"><label for="level-${i}">Nível ${i}</label></div>`;
            }
            checkboxesHtml += "</div>";
            return checkboxesHtml;
          },
          save: async () => {
            const selectedLevels = [];
            document
              .querySelectorAll('input[type="checkbox"]:checked')
              .forEach((cb) => {
                selectedLevels.push(parseInt(cb.value));
              });
            await storage.saveData(
              storage.APP_KEYS.WEEKS_VIEW_GROUPING_KEY,
              selectedLevels.sort((a, b) => a - b)
            );
            successfulSave("Agrupamento salvo com sucesso!");
          },
        },
        "hidden-activities": {
          title: "Ocultar Atividades",
          subtitle:
            "Atividades selecionadas não aparecerão no dashboard de próximas semanas.",
          needsMoreHeight: true,
          setup: async () =>
            `<select id="hidden-activities-select" multiple placeholder="Busque por código ou nome..."></select>`,
          save: async () => {
            const tomSelect = activeTomSelects[0];
            if (tomSelect) {
              await storage.saveData(
                storage.APP_KEYS.WEEKS_VIEW_HIDDEN_ACTIVITIES_KEY,
                tomSelect.getValue()
              );
              successfulSave("Lista salva!");
            }
          },
        },
        "activity-mapping": {
          title: "Mapeamento de Atividades",
          needsMoreHeight: true,
          headerAction: {
            id: "add-new-group-btn",
            icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`,
            tooltip: "Adicionar Novo Grupo",
          },
          setup: () => "",
          save: saveGroup,
        },
        restrictions: {
          title: "Gerenciar Restrições",
          needsMoreHeight: true,
          headerAction: {
            id: "add-new-restriction-btn",
            icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`,
            tooltip: "Adicionar Nova Restrição",
          },
          setup: () => "",
          save: saveRestriction,
        },
        "custom-values": {
          title: "Valores Personalizados",
          needsMoreHeight: true,
          headerAction: {
            id: "add-custom-value-btn",
            icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`,
            tooltip: "Adicionar Novo Valor",
          },
          setup: () => "",
          save: saveCustomValue,
        },
        backup: {
          title: "Importar & Exportar",
          subtitle:
            "Salve ou restaure um backup de todos os dados e configurações do sistema.",
          setup: () => `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Exportar Dados</h3>
                        <p class="text-gray-600 mb-4">Clique no botão para baixar um arquivo .json contendo todos os projetos, configurações e valores personalizados.</p>
                        <button id="export-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold">Exportar Todos os Dados</button>
                    </div>
                    <div class="border-t pt-6">
                        <h3 class="font-semibold text-lg text-gray-800 mb-2">Importar Dados</h3>
                        <p class="text-gray-600 mb-4">Arraste um arquivo de backup (.json) ou selecione-o para restaurar os dados. <strong class="text-red-600">Atenção: Isso substituirá todos os dados atuais.</strong></p>
                        <div id="import-drop-area" class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors">
                            <p class="text-gray-500">Arraste e solte o arquivo .json aqui</p>
                            <p class="text-gray-400 my-2">- OU -</p>
                            <label for="import-file-input" class="cursor-pointer bg-blue-100 text-blue-700 font-semibold px-4 py-2 rounded-md hover:bg-blue-200">Selecionar Arquivo de Backup</label>
                            <input type="file" id="import-file-input" accept=".json" class="hidden"/>
                            <p id="import-file-name" class="mt-4 text-sm font-medium text-gray-700"></p>
                        </div>
                        <button id="start-import-btn" class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Confirmar e Importar Arquivo</button>
                    </div>
                </div>`,
          save: null,
        },
      };

      // --- Inicialização da Página e Event Listeners ---
      (async () => {
        const cardConfigs = {
          "config-weeks": "weeks",
          "config-resource": "resource",
          "config-grouping": "grouping",
          "config-hidden-activities": "hidden-activities",
          "config-activity-mapping": "activity-mapping",
          "config-restrictions": "restrictions",
          "config-custom-values": "custom-values",
          "config-backup": "backup",
        };
        for (const [cardId, moduleName] of Object.entries(cardConfigs)) {
          const cardElement = document.getElementById(cardId);
          if (cardElement) {
            cardElement.addEventListener("click", async () => {
              const module = CONFIG_MODULES[moduleName];
              await openModal(module);

              // Post-modal-open setup for specific modules
              if (moduleName === "weeks") {
                document.getElementById("modal-footer").style.display = "none";
                const dropArea = document.getElementById("weeks-drop-area");
                const fileInput = document.getElementById("weeks-file-input");
                const fileNameDisplay =
                  document.getElementById("weeks-file-name");

                const handleFile = (file) => {
                  if (file) {
                    fileNameDisplay.textContent = `Arquivo: ${file.name}`;
                    processAndSaveWeeksFile(file);
                  }
                };

                ["dragenter", "dragover", "dragleave", "drop"].forEach(
                  (eventName) =>
                    dropArea.addEventListener(
                      eventName,
                      (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                      },
                      false
                    )
                );
                ["dragenter", "dragover"].forEach((eventName) =>
                  dropArea.addEventListener(
                    eventName,
                    () =>
                      dropArea.classList.add("border-blue-500", "bg-blue-50"),
                    false
                  )
                );
                ["dragleave", "drop"].forEach((eventName) =>
                  dropArea.addEventListener(
                    eventName,
                    () =>
                      dropArea.classList.remove(
                        "border-blue-500",
                        "bg-blue-50"
                      ),
                    false
                  )
                );
                dropArea.addEventListener(
                  "drop",
                  async (e) => {
                    if (e.dataTransfer.files.length > 0) {
                      handleFile(e.dataTransfer.files[0]);
                    }
                  },
                  false
                );
                fileInput.addEventListener("change", () => {
                  if (fileInput.files.length > 0) {
                    handleFile(fileInput.files[0]);
                  }
                });
              } else if (moduleName === "hidden-activities") {
                const selectEl = document.getElementById(
                  "hidden-activities-select"
                );
                const project = await getProjectBase();
                const allTasks = project?.TASK?.rows || [];
                const options = allTasks
                  .sort((a, b) => a.task_code.localeCompare(b.task_code))
                  .map((t) => ({
                    value: t.task_code,
                    text: `${t.task_code} - ${t.task_name}`,
                  }));
                if (selectEl) {
                  const tomSelect = new TomSelect(selectEl, {
                    options,
                    plugins: ["remove_button"],
                  });
                  tomSelect.setValue(
                    await storage.getData(
                      storage.APP_KEYS.WEEKS_VIEW_HIDDEN_ACTIVITIES_KEY
                    )
                  );
                  activeTomSelects.push(tomSelect);
                  activateChangeDetection();
                }
              } else if (moduleName === "activity-mapping") {
                await renderActivityMappingTable();
              } else if (moduleName === "restrictions") {
                await renderRestrictionsTable();
              } else if (moduleName === "custom-values") {
                await renderCustomValuesTable();
              } else if (moduleName === "backup") {
                document.getElementById("modal-footer").style.display = "none";

                document.getElementById("export-btn").onclick = async () => {
                  const backupData = await storage.exportAllData();
                  const blob = new Blob([JSON.stringify(backupData, null, 2)], {
                    type: "application/json",
                  });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = `chronoflow_backup_${
                    new Date().toISOString().split("T")[0]
                  }.json`;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                  showMessage("Exportação iniciada.", "success");
                };

                const importInput =
                  document.getElementById("import-file-input");
                const importBtn = document.getElementById("start-import-btn");
                const importDropArea =
                  document.getElementById("import-drop-area");
                const importFileNameDisplay =
                  document.getElementById("import-file-name");

                const handleFileSelection = (selectedFile) => {
                  if (
                    selectedFile &&
                    selectedFile.name.toLowerCase().endsWith(".json")
                  ) {
                    fileToImport = selectedFile;
                    importFileNameDisplay.textContent = `Arquivo: ${fileToImport.name}`;
                    importBtn.disabled = false;
                    importDropArea.classList.add(
                      "border-green-500",
                      "bg-green-50"
                    );
                    importDropArea.classList.remove(
                      "border-red-500",
                      "bg-red-50"
                    );
                  } else {
                    fileToImport = null;
                    importBtn.disabled = true;
                    importDropArea.classList.remove(
                      "border-green-500",
                      "bg-green-50"
                    );
                    if (selectedFile) {
                      importFileNameDisplay.textContent =
                        "Por favor, use um arquivo .json válido.";
                      importDropArea.classList.add(
                        "border-red-500",
                        "bg-red-50"
                      );
                      showMessage(
                        "Tipo de arquivo inválido. Apenas arquivos .json são permitidos.",
                        "error"
                      );
                    } else {
                      importFileNameDisplay.textContent = "";
                    }
                  }
                };

                importInput.onchange = () => {
                  handleFileSelection(
                    importInput.files.length > 0 ? importInput.files[0] : null
                  );
                };

                ["dragenter", "dragover", "dragleave", "drop"].forEach(
                  (eventName) => {
                    importDropArea.addEventListener(
                      eventName,
                      (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                      },
                      false
                    );
                  }
                );
                ["dragenter", "dragover"].forEach((eventName) => {
                  importDropArea.addEventListener(
                    eventName,
                    () => {
                      if (
                        !importDropArea.classList.contains("border-green-500")
                      ) {
                        importDropArea.classList.add(
                          "border-blue-500",
                          "bg-blue-50"
                        );
                      }
                    },
                    false
                  );
                });
                ["dragleave", "drop"].forEach((eventName) => {
                  importDropArea.addEventListener(
                    eventName,
                    () => {
                      importDropArea.classList.remove(
                        "border-blue-500",
                        "bg-blue-50"
                      );
                    },
                    false
                  );
                });
                importDropArea.addEventListener(
                  "drop",
                  (e) => {
                    if (e.dataTransfer.files.length > 0) {
                      importInput.files = e.dataTransfer.files;
                      handleFileSelection(e.dataTransfer.files[0]);
                    }
                  },
                  false
                );

                importBtn.onclick = async () => {
                  if (
                    fileToImport &&
                    confirm(
                      "Tem certeza que deseja importar este arquivo? Todos os dados atuais (projetos, configurações, etc.) serão substituídos. Esta ação não pode ser desfeita."
                    )
                  ) {
                    importBtn.textContent = "Importando...";
                    importBtn.disabled = true;
                    const reader = new FileReader();
                    reader.onload = async function (e) {
                      try {
                        const data = JSON.parse(e.target.result);
                        const importedKeys = await storage.importAllData(data);
                        if (importedKeys > 0) {
                          showMessage(
                            "Dados importados com sucesso! A página será recarregada.",
                            "success",
                            0
                          );
                          setTimeout(() => window.location.reload(), 2000);
                        } else {
                          throw new Error(
                            "O arquivo não parece ser um backup válido."
                          );
                        }
                      } catch (err) {
                        showMessage(
                          `Erro ao importar: ${err.message}`,
                          "error"
                        );
                        importBtn.textContent = "Confirmar e Importar Arquivo";
                        importBtn.disabled = false;
                      }
                    };
                    reader.readAsText(fileToImport);
                  } else if (!fileToImport) {
                    showMessage(
                      "Por favor, selecione um arquivo para importar.",
                      "error"
                    );
                  }
                };
              }
            });
          }
        }
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });
        document
          .getElementById("modal-close-btn")
          .addEventListener("click", closeModal);
        document
          .getElementById("modal-cancel-btn")
          .addEventListener("click", closeModal);

        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.classList.contains("active")) {
            closeModal();
          }
        });
      })();

      // --- Restriction Management Functions ---

      async function renderRestrictionsTable() {
        let [restrictionsList, restrictionLinks] = await Promise.all([
          storage.getData(storage.APP_KEYS.RESTRICTIONS_LIST_KEY),
          storage.getData(storage.APP_KEYS.RESTRICTION_LINKS_KEY),
        ]);
        modalSaveBtn.style.display = "none";
        modalSubtitle.textContent =
          "Gerencie todas as restrições do projeto e seus vínculos.";
        if (document.getElementById("add-new-restriction-btn")) {
          document.getElementById("add-new-restriction-btn").onclick = () =>
            renderRestrictionEditForm();
        }

        const linksByRestrictionId = restrictionLinks.reduce((acc, link) => {
          if (!acc[link.restrictionId]) acc[link.restrictionId] = [];
          acc[link.restrictionId].push(link.itemId);
          return acc;
        }, {});

        restrictionsList.sort((a, b) => a.desc.localeCompare(b.desc));

        let tableHtml = `<div class="table-container"><table><thead><tr><th>Descrição</th><th>Status</th><th>Nº de Vínculos</th><th class="text-right">Ações</th></tr></thead><tbody>`;
        if (restrictionsList.length > 0) {
          restrictionsList.forEach((restr) => {
            const linkCount = linksByRestrictionId[restr.id]?.length || 0;
            tableHtml += `
                      <tr>
                          <td class="font-semibold">${restr.desc}</td>
                          <td><span class="badge ${
                            restr.status === "pending"
                              ? "status-pending-restr"
                              : "status-resolved-restr"
                          }">${restr.status}</span></td>
                          <td>${linkCount}</td>
                          <td class="text-right">
                              <div class="flex items-center justify-end gap-2">
                                  <button class="edit-restriction-btn text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-100" data-id="${
                                    restr.id
                                  }" title="Editar Restrição"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.5 6.036z" /></svg></button>
                                  <button class="delete-restriction-btn text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100" data-id="${
                                    restr.id
                                  }" title="Excluir Restrição"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                              </div>
                          </td>
                      </tr>`;
          });
        } else {
          tableHtml += `<tr><td colspan="4" class="text-center text-gray-500 py-6">Nenhuma restrição criada.</td></tr>`;
        }
        tableHtml += `</tbody></table></div>`;
        modalBody.innerHTML = tableHtml;

        document
          .querySelectorAll(".edit-restriction-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              renderRestrictionEditForm(e.currentTarget.dataset.id)
            )
          );
        document
          .querySelectorAll(".delete-restriction-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              deleteRestriction(e.currentTarget.dataset.id)
            )
          );
      }

      async function renderRestrictionEditForm(restrictionId = null) {
        const [restrictionsList, restrictionLinks, activityMapping] =
          await Promise.all([
            storage.getData(storage.APP_KEYS.RESTRICTIONS_LIST_KEY),
            storage.getData(storage.APP_KEYS.RESTRICTION_LINKS_KEY),
            storage.getData(storage.APP_KEYS.ACTIVITY_MAPPING_KEY),
          ]);

        const restriction = restrictionId
          ? restrictionsList.find((r) => r.id === restrictionId)
          : { desc: "", resp: "", due: "", status: "pending" };
        currentEditingId = restrictionId;

        const linkedItemIds = restrictionId
          ? restrictionLinks
              .filter((l) => l.restrictionId === restrictionId)
              .map((l) => l.itemId)
          : [];

        modalSubtitle.textContent = restrictionId
          ? `Editando restrição`
          : "Criando uma nova restrição.";
        modalSaveBtn.style.display = "inline-flex";
        modalHeaderActions.innerHTML = "";

        modalBody.innerHTML = `
              <div class="space-y-4">
                  <div>
                    <label class="font-bold text-gray-700">Descrição da Restrição</label>
                    <input type="text" id="restriction-desc-input" value="${
                      restriction.desc
                    }" class="w-full p-2 border border-gray-300 rounded-md mt-1" placeholder="Ex: Atraso na entrega de material">
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div><label class="font-bold text-gray-700">Responsável</label><input type="text" id="restriction-resp-input" value="${
                        restriction.resp
                      }" class="w-full p-2 border border-gray-300 rounded-md mt-1"></div>
                      <div><label class="font-bold text-gray-700">Prazo</label><input type="date" id="restriction-due-input" value="${
                        restriction.due
                      }" class="w-full p-2 border border-gray-300 rounded-md mt-1"></div>
                      <div>
                          <label class="font-bold text-gray-700">Status</label>
                          <select id="restriction-status-select" class="w-full p-2 border border-gray-300 rounded-md mt-1">
                              <option value="pending" ${
                                restriction.status === "pending"
                                  ? "selected"
                                  : ""
                              }>Pendente</option>
                              <option value="resolved" ${
                                restriction.status === "resolved"
                                  ? "selected"
                                  : ""
                              }>Resolvido</option>
                          </select>
                      </div>
                  </div>
                  <div>
                      <label class="font-semibold text-gray-700 mt-2 block">Vincular a Atividades/Grupos:</label>
                      <select id="restriction-links-select" multiple></select>
                  </div>
              </div>`;

        const project = await getProjectBase();
        const allTasks = (project?.TASK?.rows || []).map((t) => ({
          value: t.task_code,
          text: `${t.task_code} - ${t.task_name}`,
        }));
        const allGroups = activityMapping.map((g) => ({
          value: `group::${g.groupName}`,
          text: `[Grupo] ${g.groupName}`,
        }));
        const allOptions = [...allTasks, ...allGroups].sort((a, b) =>
          a.text.localeCompare(b.text)
        );

        const tomSelect = new TomSelect("#restriction-links-select", {
          options: allOptions,
          plugins: ["remove_button"],
          placeholder: "Selecione os itens impactados...",
        });
        tomSelect.setValue(linkedItemIds);
        activeTomSelects.push(tomSelect);

        activateChangeDetection();
      }

      async function saveRestriction() {
        const desc = document
          .getElementById("restriction-desc-input")
          .value.trim();
        if (!desc) {
          showMessage("A descrição da restrição não pode ser vazia.", "error");
          return;
        }

        let [restrictionsList, restrictionLinks] = await Promise.all([
          storage.getData(storage.APP_KEYS.RESTRICTIONS_LIST_KEY),
          storage.getData(storage.APP_KEYS.RESTRICTION_LINKS_KEY),
        ]);

        const restrictionData = {
          id: currentEditingId || uuidv4(),
          desc: desc,
          resp: document.getElementById("restriction-resp-input").value,
          due: document.getElementById("restriction-due-input").value,
          status: document.getElementById("restriction-status-select").value,
        };

        if (currentEditingId) {
          const index = restrictionsList.findIndex(
            (r) => r.id === currentEditingId
          );
          if (index > -1) restrictionsList[index] = restrictionData;
        } else {
          restrictionsList.push(restrictionData);
        }

        const tomSelect = activeTomSelects[0];
        const selectedItemIds = tomSelect ? tomSelect.getValue() : [];
        const otherLinks = restrictionLinks.filter(
          (l) => l.restrictionId !== restrictionData.id
        );
        const newLinks = selectedItemIds.map((itemId) => ({
          restrictionId: restrictionData.id,
          itemId,
        }));
        const finalLinks = [...otherLinks, ...newLinks];

        await Promise.all([
          storage.saveData(
            storage.APP_KEYS.RESTRICTIONS_LIST_KEY,
            restrictionsList
          ),
          storage.saveData(storage.APP_KEYS.RESTRICTION_LINKS_KEY, finalLinks),
        ]);

        successfulSave("Restrição salva com sucesso!");
      }

      async function deleteRestriction(restrictionId) {
        if (
          confirm(
            "Tem certeza que deseja excluir esta restrição? Todos os seus vínculos também serão removidos."
          )
        ) {
          let [restrictionsList, restrictionLinks] = await Promise.all([
            storage.getData(storage.APP_KEYS.RESTRICTIONS_LIST_KEY),
            storage.getData(storage.APP_KEYS.RESTRICTION_LINKS_KEY),
          ]);

          const newRestrictionsList = restrictionsList.filter(
            (r) => r.id !== restrictionId
          );
          const newRestrictionLinks = restrictionLinks.filter(
            (l) => l.restrictionId !== restrictionId
          );

          await Promise.all([
            storage.saveData(
              storage.APP_KEYS.RESTRICTIONS_LIST_KEY,
              newRestrictionsList
            ),
            storage.saveData(
              storage.APP_KEYS.RESTRICTION_LINKS_KEY,
              newRestrictionLinks
            ),
          ]);

          showMessage("Restrição excluída.", "success");
          await renderRestrictionsTable();
        }
      }
    </script>
  </body>
</html>
