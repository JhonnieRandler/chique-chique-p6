<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Análise de Atividade P6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f2f5;
        padding: 2rem;
      }
      .card {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
      }
      .genuine-card {
        background: #fffbeb;
        border: 1px solid #fde68a;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      .info-item {
        background-color: #f8fafc;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 4px solid #6366f1;
      }
      .genuine-item {
        background-color: #fefce8;
        border-left-color: #facc15;
      }
      .info-item-label {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.25rem;
        display: block;
      }
      .info-item-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
      }
      .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-block;
      }
      .status-group {
        background-color: #eef2ff;
        color: #4338ca;
      }
      .status-not-started {
        background-color: #e2e8f0;
        color: #475569;
      }
      .status-active {
        background-color: #dbeafe;
        color: #1d4ed8;
      }
      .status-complete {
        background-color: #dcfce7;
        color: #166534;
      }
      .pred-ff {
        background-color: #fee2e2;
        color: #991b1b;
      }
      .pred-fs {
        background-color: #dbeafe;
        color: #1e40af;
      }
      .pred-ss {
        background-color: #dcfce7;
        color: #166534;
      }
      .pred-sf {
        background-color: #fef9c3;
        color: #854d0e;
      }
      .wbs-breadcrumb {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #4b5563;
      }
      .breadcrumb-item {
        background-color: #f3f4f6;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
      }
      .breadcrumb-separator {
        color: #9ca3af;
        font-weight: 600;
      }
      .ts-control {
        border-radius: 0.375rem !important;
        border: 1px solid #d1d5db !important;
        padding: 0.5rem 0.75rem !important;
      }
      .main-resource-row {
        background-color: #fef9c3;
      }
      .tooltip {
        position: relative;
        cursor: help;
      }
      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #374151;
        color: #ffffff;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        white-space: nowrap;
        z-index: 10;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .tooltip:hover::after {
        visibility: visible;
        opacity: 1;
      }
      .table-container {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      th,
      td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      td:last-child,
      th:last-child {
        border-right: 0;
      }
      th {
        background-color: #f8fafc;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      tbody tr:last-child td {
        border-bottom: 0;
      }
      tbody tr:hover {
        background-color: #f1f5f9;
      }
    </style>
  </head>
  <body>
    <div class="container mx-auto max-w-7xl">
      <div class="card">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          Análise Detalhada de Atividade
        </h1>
        <p id="project-info" class="text-gray-600 mb-6">Carregando dados...</p>
        <div class="controls-section flex flex-wrap gap-4 items-center">
          <div class="w-full md:w-96">
            <label
              for="task-select"
              class="block font-medium text-gray-700 mb-1"
              >Selecione a Atividade ou Grupo:</label
            >
            <select
              id="task-select"
              placeholder="Digite para buscar..."
            ></select>
          </div>
        </div>
      </div>
      <div id="analysis-output" class="mt-6">
        <div class="message-box">
          <p>Selecione uma atividade ou grupo para começar a análise.</p>
        </div>
      </div>
    </div>
    <script>
      const taskSelectEl = document.getElementById("task-select");
      const analysisOutput = document.getElementById("analysis-output");
      const projectInfo = document.getElementById("project-info");

      // --- Chaves do LocalStorage ---
      const WEEKS_DATA_KEY = "projectWeeksRangeData";
      const MAIN_RESOURCE_KEY = "mainProgressResource";
      const ACTIVITY_MAPPING_KEY = "activityMapping";
      const CUSTOM_VALUES_KEY = "customActivityValues";

      let allProjectsData,
        mainResource,
        tomSelectInstance,
        activityMapping,
        allTaskRsrcData,
        weeksData,
        wbsMap,
        chartInstance,
        latestProjectId,
        customValuesData;

      const STATUS_MAP = {
        TK_Complete: { text: "Concluída", class: "status-complete" },
        TK_NotStart: { text: "Não Iniciada", class: "status-not-started" },
        TK_Active: { text: "Em Andamento", class: "status-active" },
      };
      const PRED_TYPE_MAP = {
        PR_FF: {
          text: "Término-a-Término",
          class: "pred-ff",
          description:
            "A sucessora só pode terminar após o término da predecessora.",
        },
        PR_FS: {
          text: "Término-a-Início",
          class: "pred-fs",
          description:
            "A sucessora só pode iniciar após o término da predecessora.",
        },
        PR_SS: {
          text: "Início-a-Início",
          class: "pred-ss",
          description:
            "A sucessora só pode iniciar após o início da predecessora.",
        },
        PR_SF: {
          text: "Início-a-Término",
          class: "pred-sf",
          description:
            "A sucessora só pode terminar após o início da predecessora.",
        },
      };

      // --- Funções Auxiliares ---
      function formatNumberBR(num) {
        if (typeof num !== "number") num = parseFloat(num) || 0;
        return num.toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      function formatBrazilianDate(d) {
        if (!d) return "N/A";
        const [y, m, day] = d.split(" ")[0].split("-");
        return y && m && day ? `${day}/${m}/${y}` : d;
      }
      function getWeekForDate(d, w) {
        if (!d || !w || w.length === 0) return null;
        const c = new Date(d.replace(" ", "T"));
        const f = w.find((wk) => {
          const s = new Date(wk.Data_Inicio + "T00:00:00");
          const e = new Date(wk.Data_Fim + "T23:59:59");
          return c >= s && c <= e;
        });
        return f ? f.Semana : null;
      }

      // --- Carregamento Inicial ---
      window.onload = () => {
        try {
          allProjectsData = JSON.parse(
            localStorage.getItem("allProjectsData") || "{}"
          );
          mainResource = localStorage.getItem(MAIN_RESOURCE_KEY);
          activityMapping = JSON.parse(
            localStorage.getItem(ACTIVITY_MAPPING_KEY) || "[]"
          );
          allTaskRsrcData = JSON.parse(
            localStorage.getItem("allTaskRsrcData") || "[]"
          );
          weeksData = JSON.parse(localStorage.getItem(WEEKS_DATA_KEY) || "[]");
          customValuesData = new Map(
            JSON.parse(localStorage.getItem(CUSTOM_VALUES_KEY) || "[]").map(
              (item) => [item.id, item]
            )
          );

          const pids = Object.keys(allProjectsData);
          if (pids.length === 0) {
            projectInfo.textContent = "Nenhum projeto encontrado.";
            return;
          }

          latestProjectId = pids.reduce((l, c) => {
            const ld = allProjectsData[l]?.PROJECT?.rows[0]?.last_recalc_date;
            const cd = allProjectsData[c]?.PROJECT?.rows[0]?.last_recalc_date;
            return !cd ||
              (ld &&
                new Date(ld.replace(" ", "T")) > new Date(cd.replace(" ", "T")))
              ? l
              : c;
          });

          const lp = allProjectsData[latestProjectId];
          wbsMap = new Map(
            (lp.WBS_HIERARCHY?.rows || []).map((w) => [w.stable_wbs_id, w])
          );

          const lastRecalcDate = lp.PROJECT?.rows[0]?.last_recalc_date;
          const recalcWeek = getWeekForDate(lastRecalcDate, weeksData);

          projectInfo.innerHTML = recalcWeek
            ? `Analisando o projeto na <strong>semana ${recalcWeek}</strong> (com base no último .xer).`
            : `Analisando o projeto <strong>${
                lp?.PROJECT?.rows[0]?.proj_name || latestProjectId
              }</strong>.`;

          populateTaskSelect(latestProjectId);
        } catch (e) {
          console.error(e);
          analysisOutput.innerHTML = `<div class="message-box" style="color: #ef4444;">Erro ao carregar dados.</div>`;
        }
      };

      function populateTaskSelect(pid) {
        if (tomSelectInstance) tomSelectInstance.destroy();
        const tasks = allProjectsData[pid]?.TASK?.rows || [];
        const taskOptions = tasks.map((t) => ({
          value: t.task_code,
          text: `${t.task_code} - ${t.task_name}`,
          type: "task",
        }));
        const groupOptions = activityMapping.map((group) => ({
          value: `group::${group.groupName}`,
          text: `[Grupo] ${group.groupName}`,
          type: "group",
        }));
        const allOptions = [...taskOptions, ...groupOptions].sort((a, b) =>
          a.text.localeCompare(b.text)
        );

        tomSelectInstance = new TomSelect(taskSelectEl, {
          options: allOptions,
          placeholder: "Digite para buscar...",
          create: false,
          sortField: { field: "text", direction: "asc" },
        });
      }

      taskSelectEl.addEventListener("change", (e) => {
        const selectedValue = e.target.value;
        if (!selectedValue) {
          analysisOutput.innerHTML = `<div class="message-box"><p>Selecione uma atividade ou grupo.</p></div>`;
          return;
        }
        if (selectedValue.startsWith("group::")) {
          displayGroupAnalysis(selectedValue);
        } else {
          displayActivityAnalysis(selectedValue);
        }
      });

      // --- Funções de Renderização ---

      function renderGenuineValuesCard(itemId) {
        const customData = customValuesData.get(itemId);
        if (
          !customData ||
          (customData.planned === null && customData.actual === null)
        ) {
          return "";
        }

        const planned = customData.planned ?? 0;
        const actual = customData.actual ?? 0;
        const remaining = Math.max(0, planned - actual);
        const progress = planned > 0 ? (actual / planned) * 100 : 0;

        return `
            <div class="card genuine-card">
                <h2 class="text-xl font-bold text-yellow-800 mb-4">Análise de Valores Topográficos</h2>
                <div class="info-grid">
                    <div class="info-item genuine-item">
                        <span class="info-item-label">Previsto Topográfico</span>
                        <span class="info-item-value">${formatNumberBR(
                          planned
                        )}</span>
                    </div>
                    <div class="info-item genuine-item">
                        <span class="info-item-label">Realizado Topográfico</span>
                        <span class="info-item-value">${formatNumberBR(
                          actual
                        )}</span>
                    </div>
                    <div class="info-item genuine-item">
                        <span class="info-item-label">Saldo Topográfico</span>
                        <span class="info-item-value">${formatNumberBR(
                          remaining
                        )}</span>
                    </div>
                     <div class="info-item genuine-item">
                        <span class="info-item-label">% Avanço Topográfico</span>
                        <span class="info-item-value">${formatNumberBR(
                          progress
                        )}%</span>
                    </div>
                </div>
            </div>
        `;
      }

      function buildWbsPathHtml(stableIdRef) {
        if (!stableIdRef || !wbsMap || wbsMap.size === 0)
          return `<div class="wbs-breadcrumb mb-4">Caminho WBS não disponível.</div>`;
        let path = [];
        let currentId = stableIdRef;
        while (currentId && wbsMap.has(currentId)) {
          const currentWbs = wbsMap.get(currentId);
          if (currentWbs.wbs_name)
            path.unshift(
              `<span class="breadcrumb-item">${currentWbs.wbs_name}</span>`
            );
          currentId = currentWbs.parent_stable_wbs_id;
        }
        return path.length > 0
          ? `<div class="wbs-breadcrumb mb-4">${path.join(
              '<span class="breadcrumb-separator">&gt;</span>'
            )}</div>`
          : `<div class="wbs-breadcrumb mb-4">Caminho WBS não disponível.</div>`;
      }

      function displayActivityAnalysis(taskCode) {
        const latestProject = getLatestProject();
        const task = latestProject.TASK.rows.find(
          (t) => t.task_code === taskCode
        );
        if (!task) {
          analysisOutput.innerHTML = `<div class="message-box">Atividade "${taskCode}" não encontrada.</div>`;
          return;
        }

        const targetQty = parseFloat(task.target_equip_qty || 0),
          actualQty = parseFloat(task.act_equip_qty || 0);
        const realProgress = targetQty > 0 ? (actualQty / targetQty) * 100 : 0;
        const statusInfo = STATUS_MAP[task.status_code] || {
          text: task.status_code,
          class: "",
        };

        const preds =
          latestProject.TASKPRED?.rows.filter(
            (p) => p.task_id_code === taskCode
          ) || [];
        const succs =
          latestProject.TASKPRED?.rows.filter(
            (p) => p.pred_task_id_code === taskCode
          ) || [];

        const renderRelRows = (items, type) => {
          if (items.length === 0)
            return `<tr><td colspan="3" class="text-center text-gray-500 py-4">Nenhuma ${type} encontrada.</td></tr>`;
          return items
            .map((item) => {
              const typeInfo = PRED_TYPE_MAP[item.pred_type] || {
                text: item.pred_type,
                description: "Tipo desconhecido",
                class: "",
              };
              const relTaskCode =
                type === "predecessora"
                  ? item.pred_task_id_code
                  : item.task_id_code;
              return `<tr><td>${relTaskCode}</td><td><span class="badge ${typeInfo.class} tooltip" data-tooltip="${typeInfo.description}">${typeInfo.text}</span></td><td>${item.lag_hr_cnt}h</td></tr>`;
            })
            .join("");
        };

        const weeklyRecords = allTaskRsrcData.filter(
          (r) => r.task_id_code === taskCode
        );
        const byWeek = weeklyRecords.reduce((acc, rec) => {
          const recalc =
            allProjectsData[rec.proj_id]?.PROJECT?.rows[0]?.last_recalc_date;
          if (!recalc) return acc;
          const weekLabel =
            getWeekForDate(recalc, weeksData) || recalc.split(" ")[0];
          if (!acc[weekLabel]) acc[weekLabel] = { resources: [] };
          acc[weekLabel].resources.push(rec);
          return acc;
        }, {});
        const sortedWeeks = Object.keys(byWeek).sort((a, b) =>
          String(a).localeCompare(String(b), undefined, { numeric: true })
        );
        let weeklyRowsHtml =
          sortedWeeks.length === 0
            ? '<tr><td colspan="6" class="text-center text-gray-500 py-4">Nenhum histórico de recurso encontrado.</td></tr>'
            : sortedWeeks
                .map((weekLabel) =>
                  byWeek[weekLabel].resources
                    .map((res, i) => {
                      const target = parseFloat(res.target_qty || 0),
                        actual = parseFloat(res.act_reg_qty || 0);
                      const progress =
                        target > 0
                          ? `${((actual / target) * 100).toFixed(2)}%`
                          : "0.00%";
                      const isMain = res.rsrc_id_name === mainResource;
                      return `<tr class="${
                        isMain ? "main-resource-row" : ""
                      }">${
                        i === 0
                          ? `<td rowspan="${byWeek[weekLabel].resources.length}" class="align-top font-semibold">Semana ${weekLabel}</td>`
                          : ""
                      }<td>${res.rsrc_id_name}${
                        isMain ? " ⭐" : ""
                      }</td><td class="text-right">${formatNumberBR(
                        target
                      )}</td><td class="text-right">${formatNumberBR(
                        actual
                      )}</td><td class="text-right">${formatNumberBR(
                        res.remain_qty
                      )}</td><td class="text-right font-medium">${progress}</td></tr>`;
                    })
                    .join("")
                )
                .join("");

        let html = `
        <div class="card">
            <div class="flex justify-between items-start mb-2"><h2 class="text-2xl font-bold text-gray-800">${
              task.task_code
            }: ${task.task_name}</h2><span class="badge ${statusInfo.class}">${
          statusInfo.text
        }</span></div>
            ${buildWbsPathHtml(task.wbs_stable_id_ref)}
            <div class="info-grid">
                <div class="info-item"><span class="info-item-label">Início Planejado</span><span class="info-item-value">${formatBrazilianDate(
                  task.target_start_date
                )}</span></div>
                <div class="info-item"><span class="info-item-label">Término Planejado</span><span class="info-item-value">${formatBrazilianDate(
                  task.target_end_date
                )}</span></div>
                <div class="info-item"><span class="info-item-label">${
                  task.act_start_date ? "Início Real" : "Início (Tendência)"
                }</span><span class="info-item-value">${formatBrazilianDate(
          task.act_start_date || task.restart_date
        )}</span></div>
                <div class="info-item"><span class="info-item-label">${
                  task.act_end_date ? "Término Real" : "Término (Tendência)"
                }</span><span class="info-item-value">${formatBrazilianDate(
          task.act_end_date || task.reend_date
        )}</span></div>
                <div class="info-item"><span class="info-item-label">% Progresso (Cronograma)</span><span class="info-item-value">${formatNumberBR(
                  realProgress
                )}%</span></div>
            </div>
        </div>
        ${renderGenuineValuesCard(taskCode)}
        <div class="card"><h2 class="text-xl font-bold text-gray-800 mb-4">Relacionamentos</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div><h3 class="font-semibold mb-2">Predecessoras</h3><div class="table-container"><table><thead><tr><th>Atividade</th><th>Tipo</th><th>Lag</th></tr></thead><tbody>${renderRelRows(
              preds,
              "predecessora"
            )}</tbody></table></div></div>
            <div><h3 class="font-semibold mb-2">Sucessoras</h3><div class="table-container"><table><thead><tr><th>Atividade</th><th>Tipo</th><th>Lag</th></tr></thead><tbody>${renderRelRows(
              succs,
              "sucessora"
            )}</tbody></table></div></div>
        </div></div>
        <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Histórico Semanal de Recursos (Cronograma)</h2>
            <div class="table-container"><table><thead><tr><th>Semana</th><th>Recurso</th><th class="text-right">Qtd. Planejada</th><th class="text-right">Qtd. Real</th><th class="text-right">Qtd. Restante</th><th class="text-right">% Avanço</th></tr></thead><tbody>${weeklyRowsHtml}</tbody></table></div>
        </div>
        <div class="card">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Gráfico de Evolução Material</h2>
            <div><canvas id="resourceChart"></canvas></div>
        </div>
        `;
        analysisOutput.innerHTML = html;
        renderResourceChart(byWeek, sortedWeeks);
      }

      function renderResourceChart(weeklyData, sortedWeeks) {
        const ctx = document.getElementById("resourceChart")?.getContext("2d");
        if (!ctx) return;

        const labels = sortedWeeks.map((w) => `Semana ${w}`);
        const actualData = sortedWeeks.map((w) =>
          weeklyData[w].resources
            .filter((r) => r.rsrc_id_name !== mainResource)
            .reduce((sum, r) => sum + parseFloat(r.act_reg_qty || 0), 0)
        );

        if (chartInstance) chartInstance.destroy();

        if (labels.length === 0 || actualData.every((d) => d === 0)) {
          ctx.canvas.parentElement.innerHTML =
            '<p class="text-center text-gray-500 py-4">Nenhum dado de material para exibir no gráfico.</p>';
          return;
        }

        const min = Math.min(...actualData),
          max = Math.max(...actualData);
        const buffer = (max - min) * 0.1 || max * 0.1 || 1;
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Qtd. Real de Material",
                data: actualData,
                borderColor: "rgba(75, 192, 192, 1)",
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                fill: true,
                tension: 0.1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                min: min - buffer < 0 ? 0 : min - buffer,
                max: max + buffer,
                title: { display: true, text: "Quantidades" },
              },
              x: { title: { display: true, text: "Semanas" } },
            },
            plugins: {
              tooltip: { mode: "index", intersect: false },
              legend: { position: "top" },
            },
          },
        });
      }

      function displayGroupAnalysis(groupId) {
        const groupName = groupId.replace("group::", "");
        const group = activityMapping.find((g) => g.groupName === groupName);
        if (!group) return;

        const latestProject = getLatestProject();
        const tasksInGroup = latestProject.TASK.rows.filter((t) =>
          group.taskCodes.includes(t.task_code)
        );
        if (tasksInGroup.length === 0) {
          analysisOutput.innerHTML = `<div class="message-box">Nenhuma atividade para o grupo "${groupName}" no projeto.</div>`;
          return;
        }

        const resourcesInGroup = allTaskRsrcData.filter(
          (r) =>
            r.proj_id === latestProjectId &&
            group.taskCodes.includes(r.task_id_code)
        );
        const aggregatedResources = resourcesInGroup.reduce((acc, r) => {
          const name = r.rsrc_id_name;
          if (!acc[name]) acc[name] = { planned: 0, actual: 0, remaining: 0 };
          acc[name].planned += parseFloat(r.target_qty || 0);
          acc[name].actual += parseFloat(r.act_reg_qty || 0);
          acc[name].remaining += parseFloat(r.remain_qty || 0);
          return acc;
        }, {});

        const aggregatedDates = {
          target_start_date: tasksInGroup
            .map((t) => t.target_start_date)
            .filter(Boolean)
            .sort()[0],
          target_end_date: tasksInGroup
            .map((t) => t.target_end_date)
            .filter(Boolean)
            .sort()
            .pop(),
          act_start_date: tasksInGroup
            .map((t) => t.act_start_date)
            .filter(Boolean)
            .sort()[0],
          aggr_end_date: tasksInGroup.every((t) => t.act_end_date)
            ? tasksInGroup
                .map((t) => t.act_end_date)
                .filter(Boolean)
                .sort()
                .pop()
            : tasksInGroup
                .map((t) => t.reend_date || t.target_end_date)
                .filter(Boolean)
                .sort()
                .pop(),
        };
        const aggregatedEndDateLabel = tasksInGroup.every((t) => t.act_end_date)
          ? "Término Real (Mais Tarde)"
          : "Término (Tendência)";

        let resourcesHtml = Object.keys(aggregatedResources)
          .sort()
          .map((rsrcName) => {
            const r = aggregatedResources[rsrcName];
            const progress = r.planned > 0 ? (r.actual / r.planned) * 100 : 0;
            const isMain = rsrcName === mainResource;
            return `<tr class="${
              isMain ? "main-resource-row" : ""
            }"><td>${rsrcName}${
              isMain ? " ⭐" : ""
            }</td><td class="text-right">${formatNumberBR(
              r.planned
            )}</td><td class="text-right">${formatNumberBR(
              r.actual
            )}</td><td class="text-right">${formatNumberBR(
              r.remaining
            )}</td><td class="text-right font-medium">${formatNumberBR(
              progress
            )}%</td></tr>`;
          })
          .join("");

        let html = `
        <div class="card">
            <div class="flex justify-between items-start mb-4"><h2 class="text-2xl font-bold text-gray-800">${groupName}</h2><span class="badge status-group">Grupo de Atividades</span></div>
            <div class="info-grid">
                 <div class="info-item"><span class="info-item-label">Início Planejado (Agregado)</span><span class="info-item-value">${formatBrazilianDate(
                   aggregatedDates.target_start_date
                 )}</span></div>
                 <div class="info-item"><span class="info-item-label">Término Planejado (Agregado)</span><span class="info-item-value">${formatBrazilianDate(
                   aggregatedDates.target_end_date
                 )}</span></div>
                 <div class="info-item"><span class="info-item-label">Início Real (Mais Cedo)</span><span class="info-item-value">${formatBrazilianDate(
                   aggregatedDates.act_start_date
                 )}</span></div>
                 <div class="info-item"><span class="info-item-label">${aggregatedEndDateLabel}</span><span class="info-item-value">${formatBrazilianDate(
          aggregatedDates.aggr_end_date
        )}</span></div>
            </div>
        </div>
        <div class="card">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Quantidades Consolidadas por Recurso (Cronograma)</h3>
             <div class="table-container"><table><thead><tr><th>Recurso</th><th class="text-right">Total Planejado</th><th class="text-right">Total Realizado</th><th class="text-right">Total Restante</th><th class="text-right">% Progresso</th></tr></thead><tbody>${resourcesHtml}</tbody></table></div>
        </div>
        ${renderGenuineValuesCard(groupId)}
        <div class="card">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Atividades no Grupo</h3>
            <div class="table-container"><table><thead><tr><th>Código</th><th>Nome</th><th>Status</th><th class="text-right">Qtd. Planejada</th><th>Início</th><th>Término</th></tr></thead><tbody>
                  ${tasksInGroup
                    .sort(
                      (a, b) =>
                        (new Date(a.target_start_date?.replace(" ", "T")) ||
                          0) -
                        (new Date(b.target_start_date?.replace(" ", "T")) || 0)
                    )
                    .map((t) => {
                      const statusInfo = STATUS_MAP[t.status_code] || {
                        text: t.status_code,
                        class: "",
                      };
                      const plannedQty = parseFloat(t.target_equip_qty || 0);
                      return `<tr><td class="font-mono">${
                        t.task_code
                      }</td><td>${t.task_name}</td><td><span class="badge ${
                        statusInfo.class
                      }">${
                        statusInfo.text
                      }</span></td><td class="text-right">${formatNumberBR(
                        plannedQty
                      )}</td><td>${formatBrazilianDate(
                        t.act_start_date || t.restart_date
                      )}</td><td>${formatBrazilianDate(
                        t.act_end_date || t.reend_date
                      )}</td></tr>`;
                    })
                    .join("")}
            </tbody></table></div>
        </div>`;
        analysisOutput.innerHTML = html;
      }

      function getLatestProject() {
        if (!allProjectsData || Object.keys(allProjectsData).length === 0)
          return null;
        return allProjectsData[latestProjectId];
      }
    </script>
  </body>
</html>
